<?php
class Generator extends CI_Controller {				
	public function index()
	{
		die('Direct access forbidden');
	}

	/*
	 * Permet d'exporter en json la liste des applis/promos du jour
	 */
	public function json()
	{
		$this->load->model('generator_model');
		$this->load->model('os_model');
		
		$oses = $this->os_model->get_oses(); // on récupère la liste des os
		
		$date = date('Y-m-d');
		
		// pour chaque os, on va générer les fichier
		foreach ($oses as $os)
		{
			// génération des listes des promos du jour par OS
			$data['apps'] = $this->generator_model->get_promos($os['os_id'], $date);
			$data['os_name'] = $os['os_name'];
			$json = $this->load->view('friend/json_view', $data, TRUE);
			$this->_file_write($json, $os['os_id'], $os['os_name']);
			
			// génération du top gratuit
			$data['apps'] = $this->generator_model->get_top_free($os['os_id'], $date);
			$data['os_name'] = $os['os_name'];
			$json2 = $this->load->view('friend/json_view', $data, TRUE);
			$this->_file_write($json2, $os['os_id'], $os['os_name'], '_free');			
			
			// génération du top payant
			$data['apps'] = $this->generator_model->get_top_paid($os['os_id'], $date);
			$data['os_name'] = $os['os_name'];
			$json3 = $this->load->view('friend/json_view', $data, TRUE);
			$this->_file_write($json3, $os['os_id'], $os['os_name'],'_paid');
		}
		
		echo "Generation done";
	}
	
	/*
	 * Permet de tester l'envoi de notifications aux admins
	 */
	public function test_mail_alert()
	{
		$this->_alert_admin('Ceci est un mail de test, tout va bien !');
	}
	
	/*
	 * Fonction qui va écrire les fichiers (tient le rôle de vue)
	 */
	private function _file_write($str, $os_id, $name, $suffix = '')
	{
		/* DEPRECATED
		 * if (isset($this->_os_names[$os_id]) === TRUE)
		{
			$name = $this->_os_names[$os_id];
		}
		else
		{
			$this->_alert_admin('Le script a reçu des promotions pour un OS dont l\'export n\'est pas configuré');
			$name = 'undefined';			
		}*/
		
		$nb_octets = file_put_contents('./content/'.$name.''.$suffix.'.json', $str, LOCK_EX); // /content est situé au même niveau que le dossier du backend
		
		if ($nb_octets === FALSE) {
			$this->_alert_admin("Erreur dans l'écriture du fichier de l'os $os_id ($name)");
		}
	}
	
	/*
	 * Fonction qui va envoyer un mail aux administrateurs le désirant
	 * pour les prévenir qu'il y a une couille dans le pâté
	 */
	private function _alert_admin($alert)
	{
		// récupère la liste des admins qui doivent être prévenus
		$admins = $this->user_model->get_users_to_alert();
		
		foreach ($admins as $admin)
		{
			$to = $admin;
			$subject = 'Erreur dans le script d\'export d\'AppsFan';
			$message = 'Le script a rencontré l\'erreur suivante : '.$alert;
			$headers = 'From: noreply@kreactive.com' . "\r\n" .
			'X-Mailer: PHP/' . phpversion();
			
			$livraison_ok = mail($to, $subject, $message, $headers);
			
			if ($livraison_ok === TRUE)
			{
				echo 'Un mail a bien été envoyé';
			}
		}
	}
}

/* EOF */
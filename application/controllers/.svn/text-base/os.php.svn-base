<?php
class OS extends CI_Controller {
	private $_os_markets = array(
								'app_store' => 'App Store (iOS)',
								'android_market' => 'Android Market',
								'other' => 'Autre'
							);

	public function index()
	{
		$this->load->model('os_model');
		
		$data['oses'] = $this->os_model->get_oses();
		$data['markets'] = $this->_os_markets;
		
		$data['page'] = 'os/os_view';
		$this->load->view('container', $data);
	}

	public function add()
	{
		$this->load->model('os_model');
		$data['markets'] = $this->_os_markets;
		
		// validation des données
		$this->form_validation->set_rules('name', 'identifiant', 'required|callback_is_lower');
		$this->form_validation->set_rules('nice_name', 'nom', 'required');
		$this->form_validation->set_rules('market', 'Marketplace', 'required');
		
		if ($this->form_validation->run() == TRUE)
		{
			$query_data = array(
				'os_name' => $this->input->post('name'),
				'os_nice_name' => $this->input->post('nice_name'),
				'os_market' => $this->input->post('market')
			);
			$this->os_model->add_os($query_data);
			
			$this->session->set_flashdata('success', 'OS ajout&eacute;');
			redirect('os');
		}
		else
		{
			$data['page'] = 'os/os_add_view';
			$this->load->view('container', $data);
		}		
	}

	public function modify($id = -1)
	{
		$this->load->model('os_model');
		
		if ($id == -1)
		{
			$id = $this->input->post('id');
		}
		
		// validation des données
		$this->form_validation->set_rules('name', 'identifiant', 'required|callback_is_lower');
		$this->form_validation->set_rules('nice_name', 'nom', 'required');
		$this->form_validation->set_rules('market', 'Marketplace', 'required');
		
		if ($this->form_validation->run() == TRUE)
		{
			$query_data = array(
				'os_name' => $this->input->post('name'),
				'os_nice_name' => $this->input->post('nice_name'),
				'os_market' => $this->input->post('market')
			);
			$this->os_model->modify_os($id, $query_data);
			
			$this->session->set_flashdata('success', 'OS modifi&eacute; !');
			redirect('os');
		}
		else
		{
			$temp = $this->os_model->get_os($id); // récupère les infos de l'OS
			$data = array('id' => $temp['os_id'], 'name' => $temp['os_name'], 'nice_name' => $temp['os_nice_name'], 'market' => $temp['os_market']);
			$data['markets'] = $this->_os_markets;
					
			$data['page'] = 'os/os_modify_view';
			$this->load->view('container', $data);
		}		
	}
	
	/*
	 * Utilisée pour changer l'Os, appelée lors du choix dans un dropdown
	 * Si url est renseigné, on est redirigé vers la page en question, sinon vers le page /os
	 */
	public function change($id, $url = '/os')
	{
		// par défaut, on est avec la wildcart 'all'
		$this->session->set_userdata('os', $id);
		
		redirect($url);
	}

	public function delete($id)
	{
		$this->load->model('os_model');
		
		$this->os_model->delete_os($id);
		redirect('os');
	}
	
	/* 
	 * Test si un string est bien en minuscules, sans caractères spéciaux
	 */
	function is_lower($str){
		$this->form_validation->set_message('is_lower', 'Le champ %s ne doit pas contenir de caract&egrave;res sp&eacute;ciaux, d\'espaces, ou de majuscules.');
		return is_lowercase($str); // on appelle la fonction du helper
	}
}

/* EOF */
<?php
class Login extends CI_Controller {

	function index()
	{
		$this->session->set_flashdata('page', 'login');
		
		// Validation du formulaire : on n'utilise pas le mécanisme de CodeIgniter
		$this->form_validation->set_rules('username', 'nom d\'utilisateur', 'required');
		$this->form_validation->set_rules('password', 'mot de passe', 'required');
		$this->form_validation->set_message('required', '<p>Nom d\'utilisateur et/ou mot de passe incorrect</p>');

		if ($this->form_validation->run() == TRUE)
		{
			// la 1ère validation est ok, on check dans la base de données
	   		$username = $this->input->post('username');
	    	$password = $this->input->post('password');
	    	$login_ok = $this->user_model->valid_credentials($username,$password);
			
			if ($login_ok === TRUE)
			{
				$this->session->set_userdata('os', 'all'); // tous les OS
				$this->load->view('redirect'); // fait une redirection en javascript : permet de s'assurer qu'il est bien activé
			} else {
				$this->session->set_flashdata('error', 'credentials_error');
				$this->load->view('user/login_view');
			}
		} else {
			$this->load->view('user/login_view');
		}

	}
	
	function logout()
	{
		$this->session->sess_destroy();
		redirect('login');
	}
}

/* EOF */